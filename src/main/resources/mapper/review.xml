<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.travelcompass.review.model.mapper.ReviewMapper">

	<resultMap type="TripReviewDto" id="TripReviewDto">
		<result column="trip_review_id" property="tripReviewId"/>
		<result column="user_id" property="userId"/>
		<result column="attraction_title" property="attractionTitle"/>
		<result column="created_at" property="createdAt"/>
		<result column="like_count" property="likeCount"/>
		<result column="comment_nickname" property="commentNickname"/>
		<result column="comment_content" property="commentContent"/>
	</resultMap>
	
	<select id="getReviewList" resultMap="TripReviewDto">
		select 
			r1.trip_review_id, 
			u1.user_id, 
			u1.nickname, 
			a1.title as attraction_title, 
			r1.create_at, 
			r1.content, 
			r1.star, 
			count(l1.review_like_id) as like_count, 
			min(c1.nickname) as comment_nickname, 
			min(c1.content) as comment_content
		from 
			trip_review r1
		join 
			user u1 on r1.user_id = u1.user_id
		join 
			attraction_info a1 on r1.content_id = a1.content_id
		join 
			review_like l1 on r1.trip_review_id = l1.trip_review_id
		join
			(select *
			from 
				review_comment c2
			join 
				user u2 on c2.user_id = u2.user_id
			) c1 on r1.trip_review_id = c1.trip_review_id
		where 
			CASE 
	            WHEN #{searchType} = 'nickname' THEN u1.nickname = #{searchKeyword}
	            WHEN #{searchType} = 'title' THEN a1.title = #{searchKeyword}
	            WHEN #{searchType} = 'content' THEN r1.content LIKE '%' || #{searchKeyword} || '%'
	            ELSE 1 = 1
        	END
		group by
			r1.trip_review_id,
	        u1.user_id,
	        u1.nickname,
	        a1.title,
	        r1.create_at,
	        r1.content,
	        r1.star
		order by
			c1.create_at asc
	</select>
	
	
	

	<resultMap type="ReviewCommentDto" id="ReviewCommentDto">
		<result column="review_comment_id" property="reviewCommentId"/>
		<result column="trip_review_id" property="tripReviewId"/>
		<result column="parent_review_comment_id" property="parentReviewCommentId"/>
		<result column="user_id" property="userId"/>
		<result column="created_at" property="createdAt"/>
	</resultMap>
	
	<resultMap type="ReviewImageFileDto" id="ReviewImageFileDto">
		<result column="review_image_file_id" property="reviewImageFileId"/>
		<result column="trip_review_id" property="tripReviewId"/>
	</resultMap>
	
	<resultMap type="ReviewLikeDto" id="ReviewLikeDto">
		<result column="review_like_id" property="reviewLikeId"/>
		<result column="trip_review_id" property="tripReviewId"/>
		<result column="user_id" property="userId"/>
	</resultMap>
	
	<resultMap type="ReviewTagDto" id="ReviewTagDto">
		<result column="review_tag_id" property="reviewTagId"/>
		<result column="trip_review_id" property="tripReviewId"/>
	</resultMap>
	

	
	<select id="getReviewCommentList" resultMap="TripReviewDto">
		select *
		from review_comment
		where trip_review_id = #{tripReviewId}
	</select>
	
	<select id="getReviewImageFilList" resultMap="ReviewImageFileDto">
		select *
		from review_image_file
		where trip_review_id = #{tripReviewId}
	</select>
	
	<select id="getReviewLikeList" resultMap="ReviewLikeDto">
		select *
		from review_like
		where trip_review_id = #{tripReviewId}
	</select>
	
	<select id="getReviewTagList" resultMap="ReviewTagDto">
		select *
		from review_tag
		where trip_review_id = #{tripReviewId}
	</select>
	

	
</mapper>